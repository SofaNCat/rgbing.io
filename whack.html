<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RGBing(ì•Œì§€ë¹™)</title>
    <link rel="stylesheet" href="style_whack.css">
    <link rel="icon" href="icon.png" type="image/x-icon">
    <link rel="shortcut icon" href="icon.png" type="image/x-icon">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5483486229407301" crossorigin="anonymous"></script>
</head>
<body>
    <div class="option-box">
        <button id="music-toggle" class="music-button">ğŸ”•</button>
        <audio id="background-music" src="Strollin' - TrackTribe.mp3" loop></audio>
        <button id="home-toggle" class="music-button" onclick="goHome()">ğŸ </button>
        <button id="share-toggle" class="music-button" onclick="shareContent()">ğŸ’Œ</button>
        <button id="clear-toggle" class="clear-button" onclick="showClear()">ğŸ¥‡</button>
    </div>

    <div class="top-box">
        <h1>ë‘ë”ì§€ ì¡ê¸° ê²Œì„</h1>
        <p id="top-1" class="top-1"><b></b></p>
    </div>

    <div class="game-container">
        <div class="score-board">
        <div id="score"><b>ì ìˆ˜:</b> 0</div>
        <div id="lives"><b>ëª©ìˆ¨:</b> 3.0</div>
        </div>
        <div id="game-board" class="game-board"></div>
        <button id="start-button">ê²Œì„ ì‹œì‘</button>
    </div>

    <div id="qna-box" class="qna-box">
        <p class="qna-title">Q&A</p>
        <div class="color-div-2"></div>
        <p class="qna-1">1. ë‘ë”ì§€ ì¡ê¸° ê²Œì„ì€ ë¬´ì—‡ì¸ê°€ìš”?</p>
        <p class="qna-2">ë‘ë”ì§€ ì¡ê¸°ê¸° ê²Œì„ì€ <span class="qna-line">í•˜ë£¨ì— í•œ ë²ˆ</span> ì •í•´ì§€ëŠ” ì˜¤ëŠ˜ì˜ ìƒ‰ì´ ë‚˜ì˜¤ëŠ” ëª©í‘œ ì¹¸ì„ ë¹ ë¥´ê²Œ í„°ì¹˜í•˜ëŠ” ê²Œì„ì…ë‹ˆë‹¤. ëª©í‘œ ì¹¸ì„ ëˆ„ë¥´ë©´ ëª©ìˆ¨ì´ 0.5ì”© ì¦ê°€í•©ë‹ˆë‹¤!</p>
        <p class="qna-1">2. ë¸Œê¸ˆì— ëŒ€í•œ ì •ë³´ë¥¼ ì•Œê³  ì‹¶ì–´ìš”.</p>
        <p class="qna-2">ìœ íŠœë¸Œ ì˜¤ë””ì˜¤ ë³´ê´€í•¨ì— ìˆëŠ” TrackTribeì´ë¼ëŠ” ì•„í‹°ìŠ¤íŠ¸ì˜ Strollin' ìŒì•…ì„ ì‚¬ìš©í•˜ê³  ìˆì–´ìš”.</p>
    </div>

  <script>
    const musicToggleBtn = document.getElementById("music-toggle");
        const backgroundMusic = document.getElementById("background-music");

        musicToggleBtn.addEventListener("click", () => {
            if (backgroundMusic.paused) {
                backgroundMusic.play();
                musicToggleBtn.textContent = "ğŸ””";
                localStorage.setItem("audioStatus", "on");
            } else {
                backgroundMusic.pause();
                musicToggleBtn.textContent = "ğŸ”•";
                localStorage.setItem("audioStatus", "off");
            }
        });

    const gameBoard = document.getElementById("game-board");
    const scoreDisplay = document.getElementById("score");
    const livesDisplay = document.getElementById("lives");
    const startButton = document.getElementById("start-button");

    let score = 0;
    let lives = 100;
    let todayColor = "rgb(0, 0, 0)"; // Firebaseì—ì„œ ê°€ì ¸ì˜¨ ìƒ‰ìƒ ì˜ˆì‹œ
    let targetCellIndex = null;
    let clickedTarget = false;
    let timeLimit = 1500; // ì´ˆê¸° ìƒ‰ìƒ í‘œì‹œ ì‹œê°„ (1.5ì´ˆ)
    let gameInterval = null; // ê²Œì„ ì¸í„°ë²Œì„ ì €ì¥í•  ë³€ìˆ˜
    let speedLevel = 2000; // ì´ˆê¸° ì†ë„ (2ì´ˆ)
    let extraColorThreshold = 3; // ëª©í‘œ ìƒ‰ ì™¸ì˜ ë‹¤ë¥¸ ìƒ‰ì´ ë“±ì¥í•˜ëŠ” ìµœì†Œ ì‹œê°„(ì´ˆ)
    let targetActive = false; // ëª©í‘œ ìƒ‰ í™œì„± ìƒíƒœ ì¶”ì 

    const today = new Date().toLocaleDateString("ko-KR", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        timeZone: "Asia/Seoul"
    }).replace(/\./g, "/").replace(/\s/g, "").replace(/\/$/, "");

    let redValue, greenValue, blueValue;
    let clearscore, name;

    // Firebase ì´ˆê¸°í™”
    const firebaseConfig = {
        apiKey: "AIzaSyCyyqlzjApUgvJyysZKJIfY4lVz-lWmyEM",
        authDomain: "rgbing-3a593.firebaseapp.com",
        projectId: "rgbing-3a593",
        storageBucket: "rgbing-3a593.firebasestorage.app",
        messagingSenderId: "503895940241",
        appId: "1:503895940241:web:5e42593e93572563ac3330",
        measurementId: "G-RTREG5QN0D"
    };

    // Firebase ì•± ì´ˆê¸°í™”
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    function loadData() {
        // ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ì°¸ì¡°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const colorDataRef = database.ref('/color_data/' + today);
        colorDataRef.once('value', (snapshot) => {
            // ë°ì´í„°ë¥¼ JSON ê°ì²´ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const colorData = snapshot.val();

            // ì›í•˜ëŠ” ê°’ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.
            redValue = colorData.red;
            blueValue = colorData.blue;
            greenValue = colorData.green;

            todayColor = `rgb(${redValue}, ${greenValue}, ${blueValue})`;
            document.documentElement.style.setProperty('--random-color', `RGB(${redValue}, ${greenValue}, ${blueValue})`);
        });

        const colab1DataRef = database.ref('/colab/' + today + '/1/');
        colab1DataRef.once('value', (snapshot) => {
            // ë°ì´í„°ë¥¼ JSON ê°ì²´ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const colab1Data = snapshot.val();
            otherColors.push(colab1Data.hex);
        });

        const colab2DataRef = database.ref('/colab/' + today + '/2/');
        colab2DataRef.once('value', (snapshot) => {
            // ë°ì´í„°ë¥¼ JSON ê°ì²´ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const colab2Data = snapshot.val();
            otherColors.push(colab2Data.hex);
        });

        const clearDataRef = database.ref('/high_score_2/' + today + '/score/');
        clearDataRef.once('value', (snapshot) => {
            // ë°ì´í„°ë¥¼ JSON ê°ì²´ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const clearData = snapshot.val();

            // ì›í•˜ëŠ” ê°’ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.
            clearscore = clearData;
            setColorOfTheDay();
      });

      const nameDataRef = database.ref('/high_score_2/' + today + '/name/');
        nameDataRef.once('value', (snapshot) => {
            // ë°ì´í„°ë¥¼ JSON ê°ì²´ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const nameData = snapshot.val();

            // ì›í•˜ëŠ” ê°’ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.
            name = nameData;
            setColorOfTheDay();
      });
    }
    loadData();

    function setColorOfTheDay() {
      document.getElementById("clear-toggle").textContent = `ğŸ¥‡ ${clearscore}`;
      if(name != null) {
        document.getElementById("top-1").innerHTML = `<b>'${name}'ë‹˜ì„ ì´ê²¨ë¼!</b>`;
      }else {
        document.getElementById("top-1").innerHTML = `<b>ì•„ì§ ê¸°ë¡ëœ ì ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.</b>`;
      }
      
    }

    const otherColors = []; // ë‹¤ë¥¸ ìƒ‰ë“¤ (ëª©í‘œ ìƒ‰ ì œì™¸)

    // 3x3 ê·¸ë¦¬ë“œ ìƒì„±
    function createGrid() {
        gameBoard.innerHTML = ""; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
        for (let i = 0; i < 9; i++) {
            const cell = document.createElement("div");
            cell.classList.add("cell");
            cell.addEventListener("click", () => handleCellClick(i));
            gameBoard.appendChild(cell);
        }
    }

    createGrid();

    let cellColors = []; // ê° ì…€ì˜ ìƒ‰ì„ ê´€ë¦¬í•˜ëŠ” ë°°ì—´

    // ê·¸ë¦¬ë“œì—ì„œ ëœë¤í•œ ì¹¸ì— ì˜¤ëŠ˜ì˜ ìƒ‰ì„ í‘œì‹œ
    function showTargetColor() {
        const cells = document.querySelectorAll(".cell");

        // ëª©ìˆ¨ì´ 0ì´ë©´ ê²Œì„ ì¢…ë£Œ
        if (lives < 1) {
            endGame();
            return; // ê²Œì„ ì¢…ë£Œ í›„ ë” ì´ìƒ ì‹¤í–‰ë˜ì§€ ì•Šë„ë¡ ì¢…ë£Œ
        }

        // ëª©í‘œ ìƒ‰ ìœ„ì¹˜ë¥¼ ì„¤ì •
        targetCellIndex = Math.floor(Math.random() * 9);
        cells[targetCellIndex].style.backgroundColor = todayColor; // ëª©í‘œ ìƒ‰ ì¦‰ì‹œ ì„¤ì •
        cellColors[targetCellIndex] = todayColor; // ëª©í‘œ ìƒ‰ì„ ì €ì¥
        targetActive = true; // ëª©í‘œ ìƒ‰ í™œì„±í™”

        // ëª©í‘œ ìƒ‰ì„ í´ë¦­í•˜ì§€ ì•Šì•˜ìœ¼ë©´ í´ë¦­ì„ ë†“ì³¤ë‹¤ê³  ì²˜ë¦¬
        clickedTarget = false;  // ëª©í‘œ ìƒ‰ì´ ë‚˜íƒ€ë‚¬ì„ ë•Œ í´ë¦­ë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ ì´ˆê¸°í™”

        // ëª©í‘œ ìƒ‰ ì™¸ì— ë‹¤ë¥¸ ìƒ‰ì´ ì¼ì • ì‹œê°„ ì´í›„ì— ë‚˜íƒ€ë‚¨
        if (timeLimit <= 1000) {
            const otherCellIndex = Math.floor(Math.random() * 9);
            // ëª©í‘œ ìƒ‰ ì™¸ì˜ ìƒ‰ì„ ëœë¤ìœ¼ë¡œ ì„ íƒí•˜ì—¬ ë‹¤ë¥¸ ì¹¸ì— ìƒ‰ì„ ì„¤ì •
            if (otherCellIndex !== targetCellIndex) {
            const randomColor = otherColors[0];
            cells[otherCellIndex].style.backgroundColor = randomColor;
            cellColors[otherCellIndex] = randomColor; // ë‹¤ë¥¸ ìƒ‰ì„ ì €ì¥
            }
        }

        if (timeLimit <= 500) {
            const otherCellIndex = Math.floor(Math.random() * 9);
            // ëª©í‘œ ìƒ‰ ì™¸ì˜ ìƒ‰ì„ ëœë¤ìœ¼ë¡œ ì„ íƒí•˜ì—¬ ë‹¤ë¥¸ ì¹¸ì— ìƒ‰ì„ ì„¤ì •
            if (otherCellIndex !== targetCellIndex) {
            /*const randomColor = otherColors[Math.floor(Math.random() * otherColors.length)];*/
            const randomColor = otherColors[1];
            cells[otherCellIndex].style.backgroundColor = randomColor;
            cellColors[otherCellIndex] = randomColor; // ë‹¤ë¥¸ ìƒ‰ì„ ì €ì¥
            }
        }

        // ìƒ‰ì´ ì‚¬ë¼ì§
        setTimeout(() => {
            cells[targetCellIndex].style.backgroundColor = ""; // ëª©í‘œ ìƒ‰ ë°”ë¡œ ì‚¬ë¼ì§
            cellColors[targetCellIndex] = ""; // ëª©í‘œ ìƒ‰ ìƒ‰ìƒ ê°’ ì´ˆê¸°í™”
            targetActive = false; // ëª©í‘œ ìƒ‰ ë¹„í™œì„±í™”

            // ëª©í‘œ ìƒ‰ ì™¸ì˜ ìƒ‰ë„ ì‚¬ë¼ì§€ê²Œ í•˜ê¸°
            cells.forEach((cell, index) => {
            if (cellColors[index] !== todayColor) {
                cell.style.backgroundColor = ""; // ëª©í‘œ ìƒ‰ì´ ì•„ë‹Œ ì¹¸ë§Œ ì´ˆê¸°í™”
                cellColors[index] = ""; // í•´ë‹¹ ì¹¸ì˜ ìƒ‰ìƒ ê°’ ì´ˆê¸°í™”
            }
            });

            // ìƒ‰ìƒì´ ì•„ì˜ˆ ì‚¬ë¼ì§„ í›„ì— ë†“ì¹œ ëª©í‘œ ìƒ‰ì„ ì²´í¬
            checkMissedTarget();

            // ìƒ‰ì´ í‘œì‹œëœ ì‹œê°„ì„ ì ì°¨ ì¤„ì´ê¸°
            if (timeLimit <= 450 && timeLimit > 400) { // ìµœì†Œ 0.5ì´ˆê¹Œì§€ ìœ ì§€
                timeLimit -= 10;
            } else if(timeLimit > 450) {
                timeLimit -= 50;
            }
            console.log(timeLimit);
        }, timeLimit); // ìƒ‰ìƒ í‘œì‹œ ì‹œê°„
    }

    // í´ë¦­í•œ ì…€ ì²˜ë¦¬
    function handleCellClick(index) {
        const cells = document.querySelectorAll(".cell");

        // ëª©í‘œ ìƒ‰ì´ ë¹„í™œì„±í™” ìƒíƒœë©´ í´ë¦­ ì´ë²¤íŠ¸ ë¬´ì‹œ
        if (!targetActive) return;

        // ëª©í‘œ ìƒ‰ì„ í´ë¦­í•œ ê²½ìš°
        if (index === targetCellIndex && !clickedTarget) {
            score += 1;
            lives += 0.5;
            clickedTarget = true; // ëª©í‘œ ìƒ‰ì„ í´ë¦­í–ˆë‹¤ê³  í‘œì‹œ
            //cells[index].classList.add("hit");
            updateScoreboard();
        } else if (cellColors[index] !== todayColor) {
            // ëª©í‘œ ìƒ‰ ì™¸ì˜ ë‹¤ë¥¸ ìƒ‰ì„ í´ë¦­í•œ ê²½ìš° (ëª©í‘œ ìƒ‰ì´ ì•„ë‹Œ íƒ€ì¼ì„ í´ë¦­)
            //cells[index].classList.add("miss");
            setTimeout(() => {
                cells[index].classList.remove("miss");
            }, 500);
        }
    }

    // ë†“ì¹œ ëª©í‘œ í™•ì¸
    function checkMissedTarget() {
        // ëª©í‘œ ìƒ‰ì„ í´ë¦­í•˜ì§€ ì•Šì•˜ë‹¤ë©´ ëª©ìˆ¨ì„ 1 ê°ì†Œ
        if (!clickedTarget) {
            lives -= 1;
            updateScoreboard();
        }
    }

    // ê²Œì„ ì¢…ë£Œ
    function endGame() {
        clearInterval(gameInterval); // ê²Œì„ ì¸í„°ë²Œ ì¢…ë£Œ
        alert("ê²Œì„ ì˜¤ë²„! ìµœì¢… ì ìˆ˜: " + score);

        if(score > clearscore) {
            database.ref('/high_score_2/' + today).update({
                score
            });
            let userName = prompt("ì˜¤ëŠ˜ì˜ ìµœê³  ì ìˆ˜ë¥¼ ëŒíŒŒí–ˆìŠµë‹ˆë‹¤!\nê¸°ë¡í•  ë‹‰ë„¤ì„ì„ ì‘ì„±í•˜ì„¸ìš”:");
            database.ref('/high_score_2/' + today).update({
                name: userName
            });
            loadData();
        }

        // ê²Œì„ì„ ì¢…ë£Œí•œ í›„ ë²„íŠ¼ì„ í™œì„±í™”í•˜ê±°ë‚˜ ì¶”ê°€ ë™ì‘ì„ êµ¬í˜„í•  ìˆ˜ ìˆìŒ
        startButton.disabled = false; // ê²Œì„ ëë‚œ í›„ ë²„íŠ¼ì„ ë‹¤ì‹œ í™œì„±í™”
        startButton.textContent = "ë‹¤ì‹œí•˜ê¸°"; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
    }

    // ì ìˆ˜ ë° ëª©ìˆ¨ ì—…ë°ì´íŠ¸
    function updateScoreboard() {
        scoreDisplay.innerHTML = `<b>ì ìˆ˜:</b> ${score}`;
        livesDisplay.innerHTML = `<b>ëª©ìˆ¨:</b> ${lives.toFixed(1)}`;
    }

    // ê²Œì„ ì‹œì‘
    function startGame() {
        score = 0;
        lives = 3;
        updateScoreboard();
        createGrid();
        clearInterval(gameInterval); // ì´ì „ ê²Œì„ì´ ëë‚¬ìœ¼ë©´ ì¸í„°ë²Œì„ ì •ë¦¬
        gameInterval = setInterval(showTargetColor, speedLevel); // 2ì´ˆë§ˆë‹¤ ìƒ‰ìƒ ë‚˜íƒ€ë‚¨
        startButton.disabled = true; // ê²Œì„ ì‹œì‘ í›„ ë²„íŠ¼ ë¹„í™œì„±í™”
        startButton.textContent = "ì§„í–‰ ì¤‘..."; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
    }

    // ê²Œì„ ì‹œì‘ ë²„íŠ¼ í´ë¦­ ì‹œ
    startButton.addEventListener("click", startGame);

    // ì„±ê³µ íšŸìˆ˜ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
    function showClear() {
      if(name != null) {
        alert(`${today}\nì˜¤ëŠ˜ì˜ ìµœê³  ì ìˆ˜ëŠ” '${name}'ë‹˜ì´ ì„¸ìš´ ${clearscore}ì  ì…ë‹ˆë‹¤.`);
      }else {
        alert(`ì•„ì§ ê¸°ë¡ëœ ì ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.`);
      }
    }

    function goHome() {
        window.location.href = 'index.html';
    }

    function shareContent() {
        if (navigator.share) {
            navigator.share({
                title: 'ğŸ¨RGBing - ìƒ‰ ë§ì¶”ê¸° ê²Œì„ğŸ¨',
                text: 'ì—¬ëŸ¬ë¶„ë“¤ì˜ ìƒ‰ê° ì„¼ìŠ¤ë¥¼ í™œìš©í•´ì„œ ì˜¤ëŠ˜ì˜ ìƒ‰ì„ ë§ì¶°ë³´ì„¸ìš”.',
                url: window.location.href
            })
            .then(() => console.log('ê³µìœ  ì„±ê³µ'))
            .catch((error) => console.log('ê³µìœ  ì‹¤íŒ¨', error));
        } else {
            alert("ê³µìœ  ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
        }
    }
  </script>
</body>
</html>
