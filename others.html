<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style_others.css">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <title>í•˜ë£¨ê¸€</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200..900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

</head>
<body>
    <div class="menu-container">
        <div id="menu-toggle" class="menu-button">â˜°</div>
    </div>
    <div id="side-menu" class="side-menu">
        <div class="side-menu-header">
            <div id="menu-close" class="menu-close">Ã—</div>
        </div>
        <div class="menu-list">
            <div class="menu-category">
                <li onclick="window.location.href='index.html'">ğŸ  í™ˆìœ¼ë¡œ</li>
            </div>
            <div class="menu-category">
                <h4>ğŸ® ë¯¸ë‹ˆ ê²Œì„</h4>
                <ul>
                    <li onclick="window.location.href='rgbing.html'">ìƒ‰ ë§ì¶”ê¸°</li>
                    <li onclick="window.location.href='gradation.html'">ê·¸ë¼ë°ì´ì…˜</li>
                    <li onclick="window.location.href='whack.html'">ë‘ë”ì§€ ì¡ê¸°</li>
                </ul>
            </div>
            <div class="menu-category">
                <h4>ğŸ¨ ìƒ‰ ê¸°ë¡ì¥</h4>
                <ul>
                    <li onclick="goCollection()">ìƒ‰ ì»¬ë ‰ì…˜</li>
                    <li onclick="window.location.href='month.html'">ê³¼ê±°ì˜ ìƒ‰ ê¸°ë¡</li>
                </ul>
            </div>
            <div class="menu-category">
                <h4>âœ ìƒ‰ê³¼ ê¸€</h4>
                <ul>
                    <li onclick="window.location.href='login.html'">ì˜¤ëŠ˜ì˜ ê¸€</li>
                </ul>
            </div>
            <div class="menu-category">
                <h4>ğŸ“Œ ê¸°íƒ€ ë§í¬</h4>
                <ul>
                    <li onclick="goInsta()">ì¸ìŠ¤íƒ€ê·¸ë¨</li>
                    <li onclick="goBlog()">ê³µì‹ ë¸”ë¡œê·¸</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="option-box">
        <button class="music-button" onclick="window.location.href='keep.html'">ğŸ©·</button>
        <button class="music-button" onclick="window.location.href='mypage.html'">ğŸ‘¤</button>
    </div>

    <div class="day" id="day"></div>
    <!--<div class="title">ì˜¤ëŠ˜ì˜ ìƒ‰</div>-->
    <div id="color-box" class="color-box" onclick="go_write()">
        <div class="color-text"><b>ì˜¤ëŠ˜ì˜ ë‹¹ì‹ ì€ ì–´ë–¤ê°€ìš”</b></div>
    </div>
    <div class="sort-options">
        <label for="sortCriteria">ì •ë ¬ ê¸°ì¤€:</label>
        <select id="sortCriteria" onchange="updateSort()">
            <option value="latest">ìµœì‹ ìˆœ</option>
            <option value="oldest">ì˜¤ë˜ëœìˆœ</option>
            <option value="mostLiked">ì¢‹ì•„ìš” ë§ì€ ìˆœ</option>
        </select>
    </div>
    <div class="container" id="post-list">
        <!-- ì¹´ë“œë“¤ì´ í‘œì‹œë  ìë¦¬ -->
    </div>
      
    <script>
        // Firebase ì´ˆê¸°í™”
        const firebaseConfig = {
            apiKey: "AIzaSyCyyqlzjApUgvJyysZKJIfY4lVz-lWmyEM",
            authDomain: "rgbing-3a593.firebaseapp.com",
            projectId: "rgbing-3a593",
            storageBucket: "rgbing-3a593.firebasestorage.app",
            messagingSenderId: "503895940241",
            appId: "1:503895940241:web:5e42593e93572563ac3330",
            measurementId: "G-RTREG5QN0D"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const today = new Date().toLocaleDateString("ko-KR", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            timeZone: "Asia/Seoul"
        }).replace(/\./g, "/").replace(/\s/g, "").replace(/\/$/, "");

        const dayDiv = document.getElementById("day");

        dayDiv.innerHTML = today

        let redValue, greenValue, blueValue;

        // ì´ˆê¸°í™” ì‹œ Firebaseì—ì„œ ìƒ‰ìƒ ê°€ì ¸ì˜¤ê¸°
        window.onload = () => {
            loadData();
        };

        function loadData() {
            // ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ì°¸ì¡°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const colorDataRef = database.ref('/color_data/' + today);
            colorDataRef.once('value', (snapshot) => {
                // ë°ì´í„°ë¥¼ JSON ê°ì²´ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
                const colorData = snapshot.val();

                // ì›í•˜ëŠ” ê°’ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.
                redValue = colorData.red;
                blueValue = colorData.blue;
                greenValue = colorData.green;
                setColorOfTheDay();
            });
        };
        function setColorOfTheDay() {
            // CSS ë³€ìˆ˜ë¡œ ì ìš©
            document.documentElement.style.setProperty('--random-color', `RGB(${redValue}, ${greenValue}, ${blueValue})`);
        };

        const postListDiv = document.getElementById("post-list");

        // ê¸€ ì •ë ¬ ë° ë Œë”ë§
        function updateSort() {
            const sortCriteria = document.getElementById("sortCriteria").value; // ì„ íƒí•œ ì •ë ¬ ê¸°ì¤€ ê°€ì ¸ì˜¤ê¸°
            const postsPath = `posts/${today}`; // ì˜¤ëŠ˜ ë‚ ì§œì˜ ê²½ë¡œ
            const userId = localStorage.getItem('dailyWrite_user') || "guest"; // ì‚¬ìš©ì ID

            firebase.database().ref(postsPath).once("value").then((snapshot) => {
                const posts = snapshot.val();
                if (!posts || Object.keys(posts).length === 0) {
                    postListDiv.innerHTML = `
                        <div class="no-posts" style="text-align: center; font-size: 18px; color: #999; padding: 20px;">
                            ì•„ì§ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤!<br>ì˜¤ëŠ˜ì˜ ìƒ‰ìƒìœ¼ë¡œ ê¸€ì„ ì‘ì„±í•´ ë³´ì„¸ìš”.
                        </div>
                    `;
                    return;
                }

                // ê¸€ ëª©ë¡ì„ ë°°ì—´ë¡œ ë³€í™˜
                const postsArray = Object.entries(posts).map(([postId, post]) => ({
                    postId,
                    ...post
                }));

                // ì •ë ¬ ê¸°ì¤€ì— ë”°ë¼ ì •ë ¬
                if (sortCriteria === 'latest') {
                    postsArray.sort((a, b) => {
                        const dateA = new Date(`${today} ${a.time}`);
                        const dateB = new Date(`${today} ${b.time}`);
                        return dateB - dateA; // ìµœì‹ ìˆœ
                    });
                } else if (sortCriteria === 'oldest') {
                    postsArray.sort((a, b) => new Date(a.time) - new Date(b.time)); // ì˜¤ë˜ëœìˆœ
                } else if (sortCriteria === 'mostLiked') {
                    postsArray.sort((a, b) => (b.like || 0) - (a.like || 0)); // ì¢‹ì•„ìš” ë§ì€ ìˆœ
                }

                // ì •ë ¬ëœ ê¸€ ë Œë”ë§
                renderPosts(postsArray, userId);
            }).catch((error) => {
                console.error("ê¸€ ì •ë ¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                alert("ê¸€ ì •ë ¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            });
        }

        // ê¸€ ë Œë”ë§ í•¨ìˆ˜
        function renderPosts(postsArray, userId) {
            postListDiv.innerHTML = ""; // ê¸°ì¡´ ê¸€ ì´ˆê¸°í™”

            postsArray.forEach(post => {
                const { postId, title, content, like, time } = post;

                // ì¹´ë“œ ìš”ì†Œ ìƒì„±
                const cardDiv = document.createElement("div");
                cardDiv.className = "card";

                const rowDiv = document.createElement("div");
                rowDiv.className = "row";
                rowDiv.innerHTML = `<p></p><p>${time}</p>`;
                cardDiv.appendChild(rowDiv);

                const centerRowDiv = document.createElement("div");
                centerRowDiv.className = "row center";
                centerRowDiv.innerHTML = `<h3>${title}</h3>`;
                cardDiv.appendChild(centerRowDiv);

                const colorDiv = document.createElement("div");
                colorDiv.className = "color-div";
                cardDiv.appendChild(colorDiv);

                const contentDiv = document.createElement("div");
                contentDiv.className = "content";

                const sanitizedContent = content.replace(/<br\s*\/?>/g, "\n");
                const limitedContent = sanitizedContent.length > 200
                    ? sanitizedContent.substring(0, 200) + "..."
                    : sanitizedContent;

                contentDiv.textContent = limitedContent;
                cardDiv.appendChild(contentDiv);

                const likesDiv = document.createElement("div");
                likesDiv.className = "row likes";

                const likeBtn = document.createElement("button");
                likeBtn.style.background = "none";
                likeBtn.style.border = "none";
                likeBtn.style.cursor = "pointer";
                likeBtn.textContent = "ğŸ¤";
                likesDiv.appendChild(likeBtn);

                const likeCountSpan = document.createElement("span");
                likeCountSpan.textContent = like || 0;
                likesDiv.appendChild(likeCountSpan);

                cardDiv.appendChild(likesDiv);
                postListDiv.appendChild(cardDiv);

                // ì¢‹ì•„ìš” ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                firebase.database().ref(`posts/${today}/${postId}/likes/${userId}`).once("value", (snapshot) => {
                    likeBtn.textContent = snapshot.val() ? "â¤ï¸" : "ğŸ¤";
                });

                // ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                likeBtn.addEventListener("click", async () => {
                    const isLiked = likeBtn.textContent === "â¤ï¸";
                    const newLikeCount = isLiked ? (like || 0) - 1 : (like || 0) + 1;

                    // UI ì—…ë°ì´íŠ¸
                    likeBtn.textContent = isLiked ? "ğŸ¤" : "â¤ï¸";
                    likeCountSpan.textContent = newLikeCount;

                    try {
                        // Firebase ì—…ë°ì´íŠ¸
                        await firebase.database().ref(`posts/${today}/${postId}/likes/${userId}`).set(!isLiked);
                        await firebase.database().ref(`posts/${today}/${postId}`).update({
                            like: newLikeCount
                        });
                    } catch (error) {
                        console.error("ì¢‹ì•„ìš” ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", error);
                        likeBtn.textContent = isLiked ? "â¤ï¸" : "ğŸ¤";
                        likeCountSpan.textContent = like || 0;
                    }
                });
            });
        }

        function go_write() {
            const userId = localStorage.getItem('dailyWrite_user') || "guest"; // ì‚¬ìš©ì ID
            const postsPath = `posts/${today}`; // ì˜¤ëŠ˜ ë‚ ì§œ ê²½ë¡œ

            // Firebaseì—ì„œ ì‚¬ìš©ìê°€ ì˜¤ëŠ˜ ì“´ ê¸€ì´ ìˆëŠ”ì§€ í™•ì¸
            firebase.database().ref(postsPath).once("value").then((snapshot) => {
                const posts = snapshot.val();
                let hasWritten = false;

                if (posts) {
                    for (const postId in posts) {
                        if (posts[postId].user === userId) {
                            hasWritten = true;
                            break;
                        }
                    }
                }

                if (hasWritten) {
                    alert("ì˜¤ëŠ˜ ì´ë¯¸ ê¸€ì„ ì‘ì„±í•˜ì…¨ìŠµë‹ˆë‹¤!");
                } else {
                    window.location.href = `write.html`;
                }
            }).catch((error) => {
                console.error("ê¸€ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                alert("ê¸€ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë²„íŠ¼ ë¹„í™œì„±í™” í™•ì¸
        document.addEventListener("DOMContentLoaded", () => {
            const userId = localStorage.getItem('dailyWrite_user') || "guest"; // ì‚¬ìš©ì ID
            const postsPath = `posts/${today}`; // ì˜¤ëŠ˜ ë‚ ì§œ ê²½ë¡œ
            const writeButton = document.querySelector(".writeBtn");

            // Firebaseì—ì„œ ì‚¬ìš©ìê°€ ì˜¤ëŠ˜ ì“´ ê¸€ì´ ìˆëŠ”ì§€ í™•ì¸
            firebase.database().ref(postsPath).once("value").then((snapshot) => {
                const posts = snapshot.val();
                let hasWritten = false;

                if (posts) {
                    for (const postId in posts) {
                        if (posts[postId].user === userId) {
                            hasWritten = true;
                            break;
                        }
                    }
                }
            }).catch((error) => {
                console.error("ê¸€ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            });

            // ê¸°ë³¸ ì •ë ¬ ê¸°ì¤€ì„ ìµœì‹ ìˆœìœ¼ë¡œ ì„¤ì •
            document.getElementById("sortCriteria").value = "latest";
            updateSort(); // ìµœì‹ ìˆœ ì •ë ¬ í˜¸ì¶œ
        });

        const menuToggle = document.getElementById("menu-toggle");
        const sideMenu = document.getElementById("side-menu");
        const menuClose = document.getElementById("menu-close");

        menuToggle.addEventListener("click", () => {
            sideMenu.style.left = "0";
            menuToggle.style.display = "none"; // ë©”ë‰´ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        });

        menuClose.addEventListener("click", () => {
            sideMenu.style.left = "-250px";
            menuToggle.style.display = "block";
        });

        function goCollection() {
            let userName = prompt("ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:");
            if(userName != null) {
                // ì‚¬ìš©ì IDê°€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                const userRef = database.ref('users/' + userName);
                userRef.once('value', function(snapshot) {
                    if (snapshot.exists()) {
                        let userPass = prompt("ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:");
                        const userRef2 = database.ref('users/' + userName + '/password');
                        userRef2.once('value', function(snapshot) {
                            if (snapshot.val() == userPass) {
                                if(userName == 'ê´€ë¦¬ì') {
                                    localStorage.setItem('userName', userName);
                                    window.location.href = 'collection_manager.html';
                                }
                                else {
                                    localStorage.setItem('userName', userName);
                                    window.location.href = 'collection.html';
                                }
                            } else {
                                alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                            }
                        });
                    } else {
                        alert("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ID ì…ë‹ˆë‹¤.");
                    }
                });
            }
            else alert("ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
        function goInsta() {
            window.location.href = 'https://www.instagram.com/sofancat_com/profilecard/?igsh=MXI1ZDNqNjExNTJ4dQ==';
        }
        function goBlog() {
            window.location.href = 'https://rgbing.tistory.com/';
        }
    </script>

</body>
</html>
