<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style_write.css">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <title>RGBing(ì•Œì§€ë¹™)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200..900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

</head>
<body>
    <div class="menu-container">
        <div id="menu-toggle" class="menu-button">â˜°</div>
    </div>
    <div id="side-menu" class="side-menu">
        <div class="side-menu-header">
            <div id="menu-close" class="menu-close">Ã—</div>
        </div>
        <div class="menu-list">
            <div class="menu-category">
                <li onclick="window.location.href='index.html'">ğŸ  í™ˆìœ¼ë¡œ</li>
            </div>
            <div class="menu-category">
                <h4>ğŸ® ë¯¸ë‹ˆ ê²Œì„</h4>
                <ul>
                    <li onclick="window.location.href='rgbing.html'">ìƒ‰ ë§ì¶”ê¸°</li>
                    <li onclick="window.location.href='gradation.html'">ê·¸ë¼ë°ì´ì…˜</li>
                    <li onclick="window.location.href='whack.html'">ë‘ë”ì§€ ì¡ê¸°</li>
                </ul>
            </div>
            <div class="menu-category">
                <h4>ğŸ¨ ìƒ‰ ê¸°ë¡ì¥</h4>
                <ul>
                    <li onclick="goCollection()">ìƒ‰ ì»¬ë ‰ì…˜</li>
                    <li onclick="window.location.href='month.html'">ê³¼ê±°ì˜ ìƒ‰ ê¸°ë¡</li>
                </ul>
            </div>
            <div class="menu-category">
                <h4>âœ ìƒ‰ê³¼ ê¸€</h4>
                <ul>
                    <li onclick="window.location.href='login.html'">ì˜¤ëŠ˜ì˜ ê¸€</li>
                </ul>
            </div>
            <div class="menu-category">
                <h4>ğŸ“Œ ê¸°íƒ€ ë§í¬</h4>
                <ul>
                    <li onclick="goInsta()">ì¸ìŠ¤íƒ€ê·¸ë¨</li>
                    <li onclick="goBlog()">ê³µì‹ ë¸”ë¡œê·¸</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="option-box">
        <button class="music-button" onclick="window.location.href='keep.html'">ğŸ©·</button>
        <button class="music-button" onclick="window.location.href='mypage.html'">ğŸ‘¤</button>
    </div>

    <div class="day" id="day"></div>
    <div id="color-box" class="color-box">
        <div class="color-text"><b>ì˜¤ëŠ˜ì˜ ë‹¹ì‹ ì€ ì–´ë–¤ê°€ìš”</b></div>
    </div>
    <div class="container"> 
        <div class="notice-box">
            <p>ğŸ’¡ ë‹¤ì–‘í•œ ê°ì •ì„ ììœ ë¡­ê²Œ í‘œí˜„í•˜ì„¸ìš”.</p>
            <p>ğŸ’¡ ë‹¤ë§Œ, ìƒëŒ€ë°©ì„ ë°°ë ¤í•˜ëŠ” ê¸€ì“°ê¸°ë¥¼ ì§€í–¥í•©ë‹ˆë‹¤.</p>
            <p>ğŸ’¡ ìš•ì„¤, í˜ì˜¤ í‘œí˜„, ë¶ˆë²•ì ì¸ ë‚´ìš©ì€ <b>í†µë³´ ì—†ì´ ì‚­ì œ</b>ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <p>ğŸ’¡ í•œ ë²ˆ ì—…ë¡œë“œí•œ ê¸€ì€ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
        <textarea class="titleInput" id="titleInput" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”." maxlength="350"></textarea>
        <textarea class="textInput" id="textInput" placeholder="í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”." maxlength="350"></textarea>
        <div id="counter">
            <p>ê¸€ì ìˆ˜: <span id="charCount">0/350</span></p>
        </div>
        <button id="saveButton" class="buttons">ì¤‘ê°„ ì €ì¥</button>
        <button id="clearButton" class="buttons">ì§€ìš°ê¸°</button>
        <button id="uploadButton" class="buttons" onclick="upload_ok()">ì—…ë¡œë“œ</button>
        <div id="preview">
            <h4>ë¯¸ë¦¬ë³´ê¸°</h2>
            <p id="textPreview"></p>
        </div>
    </div>

    <script>
        // Firebase ì´ˆê¸°í™”
        const firebaseConfig = {
            apiKey: "AIzaSyCyyqlzjApUgvJyysZKJIfY4lVz-lWmyEM",
            authDomain: "rgbing-3a593.firebaseapp.com",
            projectId: "rgbing-3a593",
            storageBucket: "rgbing-3a593.firebasestorage.app",
            messagingSenderId: "503895940241",
            appId: "1:503895940241:web:5e42593e93572563ac3330",
            measurementId: "G-RTREG5QN0D"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const today = new Date().toLocaleDateString("ko-KR", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            timeZone: "Asia/Seoul"
        }).replace(/\./g, "/").replace(/\s/g, "").replace(/\/$/, "");
        const savedate = today;

        const dayDiv = document.getElementById("day");

        dayDiv.innerHTML = today

        let redValue, greenValue, blueValue;

        function loadData() {
            // ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ì°¸ì¡°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const colorDataRef = database.ref('/color_data/' + today);
            colorDataRef.once('value', (snapshot) => {
                // ë°ì´í„°ë¥¼ JSON ê°ì²´ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
                const colorData = snapshot.val();

                // ì›í•˜ëŠ” ê°’ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.
                redValue = colorData.red;
                blueValue = colorData.blue;
                greenValue = colorData.green;

                // í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½
                const isBlack = colorData.black; // Firebaseì—ì„œ 'black' ê°’ ê°€ì ¸ì˜¤ê¸°
                updateTextColor(isBlack);

                setColorOfTheDay();
            });
        };
        function setColorOfTheDay() {
            // CSS ë³€ìˆ˜ë¡œ ì ìš©
            document.documentElement.style.setProperty('--random-color', `RGB(${redValue}, ${greenValue}, ${blueValue})`);
        };
        function updateTextColor(isBlack) {
            const colorTextElement = document.querySelector('.color-text');
            if (isBlack) {
                colorTextElement.style.color = 'black';
            } else {
                colorTextElement.style.color = 'white';
            }
        }

        document.getElementById("saveButton").addEventListener("click", () => {
            const title = document.getElementById("titleInput").value;
            const text = document.getElementById("textInput").value;
            localStorage.setItem("savedTitle", title);
            localStorage.setItem("savedText", text);
            updatePreview(text);
        });

        document.getElementById("clearButton").addEventListener("click", () => {
            document.getElementById("titleInput").value = "";
            document.getElementById("textInput").value = "";
            localStorage.removeItem("savedTitle");
            localStorage.removeItem("savedText");
            updatePreview("");
        });

        function updatePreview(text) {
            const previewElement = document.getElementById("textPreview");
            previewElement.innerHTML = text.replace(/\n/g, "<br>"); // ì¤„ë°”ê¿ˆì„ <br>ë¡œ ë³€í™˜
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ í…ìŠ¤íŠ¸ ë¡œë“œ
        window.onload = () => {
            loadData();

            const savedTitle = localStorage.getItem("savedTitle");
            const savedText = localStorage.getItem("savedText");
            if (savedText) {
                document.getElementById("titleInput").value = savedTitle;
                document.getElementById("textInput").value = savedText;
                updatePreview(savedText);
            }
        };
        document.getElementById("textInput").addEventListener("input", () => {
            const text = document.getElementById("textInput").value;
            document.getElementById("charCount").innerText = `${text.length}/350`;
        });

        function upload_ok() {
            const textInput = document.getElementById("textInput").value;
            const titleInput = document.getElementById("titleInput").value;

            // ê¸€ ë‚´ìš©ì´ ë¹„ì–´ìˆëŠ” ê²½ìš° ì—…ë¡œë“œ ì°¨ë‹¨
            if (!textInput.trim()) {
                alert("ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            const today = new Date().toLocaleDateString("ko-KR", {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                timeZone: "Asia/Seoul"
            }).replace(/\./g, "/").replace(/\s/g, "").replace(/\/$/, "");
            const postsPath = `posts/${today}`;
            const userNickname = localStorage.getItem("dailyWrite_user") || "guest"; // ì‚¬ìš©ì ë‹‰ë„¤ì„ (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ê°€ì ¸ì˜´)

            // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            firebase.database().ref(`users/${userNickname}`).once("value").then((snapshot) => {
                const userData = snapshot.val();

                if (!userData) {
                    alert("ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                    return;
                }

                const userAge = userData.age || "ì•Œ ìˆ˜ ì—†ìŒ"; // ì‚¬ìš©ì ë‚˜ì´ (ê¸°ë³¸ê°’: 'ì•Œ ìˆ˜ ì—†ìŒ')

                // ì˜¤ëŠ˜ ì˜¬ë¼ì˜¨ ê²Œì‹œë¬¼ ìˆ˜ë¥¼ êµ¬í•˜ê¸°
                firebase.database().ref(postsPath).once("value").then((snapshot) => {
                    const posts = snapshot.val() || {};
                    const keys = Object.keys(posts);

                    // ê°€ì¥ í° ë²ˆí˜¸ë¥¼ ì°¾ì•„ +1
                    let newPostId = 1; // ê¸°ë³¸ê°’: 1
                    if (keys.length > 0) {
                        newPostId = Math.max(...keys.map(Number)) + 1;
                    }

                    // ì¤„ë°”ê¿ˆì„ <br>ë¡œ ë³€í™˜
                    const formattedContent = textInput.replace(/\n/g, "<br>");

                    // ìƒˆ ê²Œì‹œë¬¼ ë°ì´í„° ìƒì„±
                    const postData = {
                        title: titleInput,
                        content: formattedContent, // ì¤„ë°”ê¿ˆ ë³€í™˜ëœ í…ìŠ¤íŠ¸
                        time: new Date().toLocaleTimeString("ko-KR", { hour: "2-digit", minute: "2-digit", hourCycle: "h23" }),
                        like: 0, // ì´ˆê¸° ì¢‹ì•„ìš” ìˆ˜
                        user: userNickname, // ì‚¬ìš©ì ë‹‰ë„¤ì„
                    };

                    // ê²Œì‹œë¬¼ ë°ì´í„° ì €ì¥
                    firebase.database().ref(`${postsPath}/${newPostId}`).set(postData)
                        .then(() => {
                            alert("ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!");
                            document.getElementById("textInput").value = ""; // ì…ë ¥ì°½ ì´ˆê¸°í™”
                            updatePreview(""); // ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
                            localStorage.removeItem("savedTitle");
                            localStorage.removeItem("savedText"); // ë¡œì»¬ ì €ì¥ ë°ì´í„° ì œê±°
                            window.location.href = `others.html`;
                        })
                        .catch((error) => {
                            console.error("ê¸€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                            alert("ê¸€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                        });
                });
            }).catch((error) => {
                console.error("ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:", error);
                alert("ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
        }

        const menuToggle = document.getElementById("menu-toggle");
        const sideMenu = document.getElementById("side-menu");
        const menuClose = document.getElementById("menu-close");

        menuToggle.addEventListener("click", () => {
            sideMenu.style.left = "0";
            menuToggle.style.display = "none"; // ë©”ë‰´ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        });

        menuClose.addEventListener("click", () => {
            sideMenu.style.left = "-250px";
            menuToggle.style.display = "block";
        });

        function goCollection() {
            let userName = prompt("ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:");
            if(userName != null) {
                // ì‚¬ìš©ì IDê°€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                const userRef = database.ref('users/' + userName);
                userRef.once('value', function(snapshot) {
                    if (snapshot.exists()) {
                        let userPass = prompt("ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:");
                        const userRef2 = database.ref('users/' + userName + '/password');
                        userRef2.once('value', function(snapshot) {
                            if (snapshot.val() == userPass) {
                                if(userName == 'ê´€ë¦¬ì') {
                                    localStorage.setItem('userName', userName);
                                    window.location.href = 'collection_manager.html';
                                }
                                else {
                                    localStorage.setItem('userName', userName);
                                    window.location.href = 'collection.html';
                                }
                            } else {
                                alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                            }
                        });
                    } else {
                        alert("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ID ì…ë‹ˆë‹¤.");
                    }
                });
            }
            else alert("ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
        function goInsta() {
            window.location.href = 'https://www.instagram.com/sofancat_com/profilecard/?igsh=MXI1ZDNqNjExNTJ4dQ==';
        }
        function goBlog() {
            window.location.href = 'https://rgbing.tistory.com/';
        }
    </script>
</body>
</html>
